# VChat Heap Exploit: Heaps of Fun
> [!NOTE]
> This is not based on an existing writeup, but the vulnerabilities added to the VChat server are based on a [blog](https://www.rapid7.com/blog/post/2019/06/12/heap-overflow-exploitation-on-windows-10-explained/) with additional modifications so they fit into the VChat server.
---

This writeup will cover the exploitation of the [VChat](https://github.com/xinwenfu/vchat) server program, we have modified this to include a few HEAP exploits. The first is a simple example based on the example programs previously discussed, all we have to worry about is the content we are overflowing into the program's heap structure. The second is slightly more complex as the heap is not automatically put into a vulnerable state as was done with the simpler example. Instead we need to send a series of messages in order to put the heap into a vulnerable state for the overflow.

> [!IMPORTANT] 
> For an explanation on how this exploit works, please refer to the [Heap-Overflow-Example](https://github.com/DaintyJet/Heap-Overflow-Example) writeup or the [VChat_Heap_Defense](https://github.com/DaintyJet/VChat_Heap_Defense) writeups.

## VChat Setup and Configuration
This section covers the compilation process, and use of the VChat Server. We include instructions for both the original VChat code which was compiled with MinGW and GCC on Windows, and the newly modified code that can be compiled with the Visual Studio C++ compiler.

### Visual Studio
1. Open the [Visual Studio project](https://github.com/DaintyJet/vchat-fork/tree/main/Server/Visual%20Studio%20Projects/DLL/Essfun) for the *essfunc* DLL.
2. Build the project, as this contains inline assembly the target DLL file must be compiled as a x86 DLL (32-bits).
3. Copy the Resulting DLL from the *Debug* folder in the [Essfunc Project](https://github.com/DaintyJet/vchat-fork/tree/main/Server/Visual%20Studio%20Projects/DLL/Essfun/Debug) into the *Debug* folder in the [VChat Project](https://github.com/DaintyJet/vchat-fork/tree/main/Server/Visual%20Studio%20Projects/EXE/VChat/Debug)

	<img src="Images/VS-Comp.png">

4. Open the [Visual Studio project](https://github.com/DaintyJet/vchat-fork/tree/main/Server/Visual%20Studio%20Projects/EXE/VChat) for the *VChat* EXE.
5. Build the Project; our executable will be in the *Debug* folder. You can then launch the executable!
### Mingw/GCC
Compile VChat and its dependencies if they have not already been compiled. This is done with mingw.

1. Create the essfunc object File.
	```powershell
	# Compile Essfunc Object file
	$ gcc.exe -c essfunc.c
	```
2. Create the [DLL](https://learn.microsoft.com/en-us/troubleshoot/windows-client/deployment/dynamic-link-library) containing functions that will be used by the VChat.
	```powershell
	# Create a DLL with a static (preferred) base address of 0x62500000
	$ gcc.exe -shared -o essfunc.dll -Wl,--out-implib=libessfunc.a -Wl,--image-base=0x62500000 essfunc.o
	```
      * ```-shared -o essfunc.dll```: We create a DLL "essfunc.dll", these are equivalent to the [shared library](https://tldp.org/HOWTO/Program-Library-HOWTO/shared-libraries.html) in Linux.
      * ```-Wl,--out-implib=libessfunc.a```: We tell the linker to generate an import library "libessfunc.a" [2].
      * ```-Wl,--image-base=0x62500000```: We specify the [Base Address](https://learn.microsoft.com/en-us/cpp/build/reference/base-base-address?view=msvc-170) as ```0x62500000``` [3].
      * ```essfunc.o```: We build the DLL based off of the object file "essfunc.o"
3. Compile the VChat application.
	```powershell
	# Compile and Link VChat
	$ gcc.exe vchat.c -o vchat.exe -lws2_32 ./libessfunc.a
	```
      * ```vchat.c```: The source file is "vchat.c".
      * ```-o vchat.exe```: The output file will be the executable "vchat.exe".
      * ```-lws2_32 ./libessfunc.a```: Link the executable against the import library "libessfunc.a", enabling it to use the DLL "essfunc.dll".

## Exploitation: Simple Exploit
This section will cover the exploitation of the simpler all-in-one exploit now provided in VChat. We can send messages to the `HEAP1` function in the format `HEAP1 *<MESSAGE>*` and the contents between the two asterisks will be placed onto the heap; from this we will attempt to gain a remote shell in this idealized and simplified scenario.

## Exploitation: Complex Exploit


## Test code
